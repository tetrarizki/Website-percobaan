<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>KAWAN SEJAGAT NUSANTARA</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f4f6f8;
}

/* ================= LOGIN ================= */

.login-wrapper{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
}

.login-box{
  width:340px;
  background:#fff;
  padding:30px;
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}

.login-box h3{
  text-align:center;
  margin-bottom:20px;
}

.input-group{
  position:relative;
  margin-bottom:15px;
}

.input-group input{
  width:100%;
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing:border-box;
}

.show-pass{
  position:absolute;
  right:10px;
  top:10px;
  font-size:13px;
  cursor:pointer;
  color:#2c7be5;
}

.login-box button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:6px;
  background:#2c7be5;
  color:#fff;
  cursor:pointer;
}

.hidden{display:none}

/* ================= APP ================= */

.app-container{
  padding:20px;
}

.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:15px;
}

.controls input,
.controls select,
.controls button{
  padding:8px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

th,td{
  border:1px solid #ddd;
  padding:8px;
}

th{
  background:#2c7be5;
  color:#fff;
  cursor:pointer;
  position:sticky;
  top:0;
}

th span{
  font-size:12px;
  margin-left:5px;
}

.center{text-align:center}
.gangguan{background:#f4cccc!important}

.pagination{
  margin-top:15px;
}

.telegram-float{
  position:fixed;
  bottom:25px;
  right:25px;
  width:60px;
  height:60px;
  background:#0088cc;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 6px 18px rgba(0,0,0,.3);
  animation:bounce 2s infinite;
  text-decoration:none;
  color:white;
  font-size:24px;
}

@keyframes bounce{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

/* ================= MODAL ================= */

.modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
}

.modal.active{
  display:flex;
}

.modal-box{
  background:#fff;
  width:600px;
  max-height:80vh;
  overflow:auto;
  padding:20px;
  border-radius:8px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrapper" class="login-wrapper">
  <div class="login-box">
    <h3>Login</h3>

    <div class="input-group">
      <input id="username" placeholder="Username">
    </div>

    <div class="input-group">
      <input id="password" type="password" placeholder="Password">
      <span class="show-pass" onclick="togglePassword()">Show</span>
    </div>

    <button onclick="login()">Login</button>
  </div>
</div>

<!-- APP -->
<div id="app" class="app-container hidden">

<h2>KAWAN SEJAGAT NUSANTARA</h2>

<div class="controls">
<input id="searchBox" placeholder="Cari...">
<select id="filterProvider"><option value="ALL">Semua Provider</option></select>
<select id="filterKategori"><option value="ALL">Semua Kategori</option></select>
<button onclick="exportExcel()">Export</button>
<button id="adminBtn" class="hidden" onclick="openAdmin()">⚙ Pengaturan</button>
<button onclick="logout()">Logout</button>
</div>

<table>
<thead>
<tr>
<th data-key="Kode">Kode <span></span></th>
<th data-key="Keterangan">Keterangan <span></span></th>
<th data-key="Harga">Harga <span></span></th>
<th data-key="Status">Status <span></span></th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>

<div class="pagination">
<button onclick="prevPage()">Prev</button>
<span id="pageInfo"></span>
<button onclick="nextPage()">Next</button>
</div>

</div>

<!-- MODAL ADMIN -->
<div id="adminModal" class="modal">
<div class="modal-box">
<h3>Manajemen User</h3>
<hr>
<input id="u_username" placeholder="Username"><br><br>
<input id="u_password" placeholder="Password"><br><br>
<input id="u_sheet" placeholder="Sheet CSV URL"><br><br>
<select id="u_role">
<option value="user">User</option>
<option value="admin">Admin</option>
</select><br><br>
<button onclick="saveUser()">Simpan</button>
<button onclick="resetForm()">Reset</button>
<hr>
<table width="100%" border="1">
<thead><tr><th>User</th><th>Role</th><th>Aksi</th></tr></thead>
<tbody id="userTable"></tbody>
</table>
<br>
<button onclick="closeAdmin()">Tutup</button>
</div>
</div>

<a href="https://t.me/CSKSN" target="_blank" class="telegram-float">✈</a>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
const API_URL="ISI_URL_APPS_SCRIPT_KAMU";

/* ================= LOGIN ================= */

function togglePassword(){
const p=document.getElementById("password");
p.type=p.type==="password"?"text":"password";
}

async function login(){
const res=await fetch(API_URL);
const users=await res.json();
const u=users.find(x=>x.username===username.value&&x.password===password.value);
if(!u)return alert("Login salah");

localStorage.setItem("login","1");
localStorage.setItem("role",u.role);
localStorage.setItem("sheet_url",u.sheet_url);

showApp();
loadUserSheet();
}

function logout(){
localStorage.clear();
location.reload();
}

function showApp(){
loginWrapper.classList.add("hidden");
app.classList.remove("hidden");
if(localStorage.getItem("role")==="admin")
adminBtn.classList.remove("hidden");
}

if(localStorage.getItem("login")==="1"){
showApp();
loadUserSheet();
}

/* ================= DATA ================= */

let allData=[],filteredData=[],currentPage=1;
let sortKey=null,sortDir="asc";
const PAGE_SIZE=100;

function loadUserSheet(){
Papa.parse(localStorage.getItem("sheet_url"),{
download:true,
header:true,
complete:res=>{
allData=res.data.filter(r=>r.Kode);
loadKategori();
loadProvider();
applyFilter();
}
});
}

function formatHarga(v){
const n=Number((v||"").toString().replace(/[^0-9]/g,""));
return "Rp. "+n.toLocaleString("id-ID");
}

function loadKategori(){
filterKategori.innerHTML='<option value="ALL">Semua Kategori</option>';
[...new Set(allData.map(r=>r.Kategori))].forEach(k=>{
filterKategori.innerHTML+=`<option value="${k}">${k}</option>`;
});
}

function loadProvider(){
filterProvider.innerHTML='<option value="ALL">Semua Provider</option>';
const providers=["AXIS","ECOMMERCE","GAME","INDOSAT","PROMO","SALDO","SMART","SMARTFREN","TELKOMSEL","THREE","VOUCHER","XL","XL/AXIS"];
providers.forEach(p=>{
filterProvider.innerHTML+=`<option value="${p}">${p}</option>`;
});
}

function applyFilter(){
const q=searchBox.value.toLowerCase();
filteredData=allData.filter(r=>
(`${r.Kode} ${r.Keterangan}`.toLowerCase().includes(q))
);
sortData();
currentPage=1;
render();
}

searchBox.oninput=applyFilter;

function sortData(){
if(!sortKey)return;
filteredData.sort((a,b)=>{
let A=a[sortKey],B=b[sortKey];
if(sortKey==="Harga"){
A=Number(A.toString().replace(/[^0-9]/g,""));
B=Number(B.toString().replace(/[^0-9]/g,""));
}
if(A<B)return sortDir==="asc"?-1:1;
if(A>B)return sortDir==="asc"?1:-1;
return 0;
});
}

document.querySelectorAll("th[data-key]").forEach(th=>{
th.onclick=()=>{
sortDir=(sortKey===th.dataset.key&&sortDir==="asc")?"desc":"asc";
sortKey=th.dataset.key;
document.querySelectorAll("th span").forEach(s=>s.textContent="");
th.querySelector("span").textContent=sortDir==="asc"?"▲":"▼";
sortData();
render();
};
});

function render(){
dataTable.innerHTML="";
filteredData.slice((currentPage-1)*PAGE_SIZE,currentPage*PAGE_SIZE)
.forEach(r=>{
const tr=document.createElement("tr");
if(r.Status?.toLowerCase()==="gangguan")tr.classList.add("gangguan");
tr.innerHTML=`
<td class="center">${r.Kode}</td>
<td>${r.Keterangan}</td>
<td class="center">${formatHarga(r.Harga)}</td>
<td class="center">${r.Status}</td>`;
dataTable.appendChild(tr);
});
pageInfo.textContent=`Page ${currentPage}/${Math.ceil(filteredData.length/PAGE_SIZE)||1}`;
}

function prevPage(){if(currentPage>1){currentPage--;render();}}
function nextPage(){if(currentPage<Math.ceil(filteredData.length/PAGE_SIZE)){currentPage++;render();}}

function exportExcel(){
const ws=XLSX.utils.json_to_sheet(filteredData.map(r=>({
Kode:r.Kode,
Keterangan:r.Keterangan,
Harga:formatHarga(r.Harga),
Status:r.Status
})));
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Harga");
XLSX.writeFile(wb,"hasil_export.xlsx");
}

/* ================= ADMIN CRUD ================= */

function openAdmin(){
adminModal.classList.add("active");
loadUsers();
}

function closeAdmin(){
adminModal.classList.remove("active");
}

async function loadUsers(){
const res=await fetch(API_URL);
const users=await res.json();
userTable.innerHTML="";
users.forEach(u=>{
userTable.innerHTML+=`
<tr>
<td>${u.username}</td>
<td>${u.role}</td>
<td>
<button onclick='editUser(${JSON.stringify(u)})'>Edit</button>
<button onclick='deleteUser("${u.username}")'>Hapus</button>
</td>
</tr>`;
});
}

async function saveUser(){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"add",
username:u_username.value,
password:u_password.value,
role:u_role.value,
sheet_url:u_sheet.value
})
});
resetForm();
loadUsers();
}

function editUser(u){
u_username.value=u.username;
u_password.value=u.password;
u_role.value=u.role;
u_sheet.value=u.sheet_url;
}

async function deleteUser(username){
if(!confirm("Hapus user?"))return;
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({action:"delete",username})
});
loadUsers();
}

function resetForm(){
u_username.value="";
u_password.value="";
u_sheet.value="";
u_role.value="user";
}
</script>
</body>
</html>
